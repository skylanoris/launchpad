---
- name: Bootstrap Python on DietPi if missing
  hosts: dietpi
  gather_facts: no
  become: yes

  tasks:
    - name: Check if Python 3 is installed
      ansible.builtin.raw: test -x /usr/bin/python3
      register: python_check
      changed_when: false
      failed_when: python_check.rc not in [0, 1]

    - name: Install Python 3 if missing
      ansible.builtin.raw: |
        apt-get update -y && apt-get install -y python3
      when: python_check.rc != 0

- name: Update DietPi system
  hosts: dietpi
  become: yes
  gather_facts: yes

  tasks:
    - name: Ensure system package lists are up to date
      ansible.builtin.apt:
        update_cache: yes
        
    - name: Run DietPi update
      ansible.builtin.command: /boot/dietpi/dietpi-update 1
      environment:
        TERM: dumb
      register: dietpi_update
      changed_when: "'No updates required' not in dietpi_update.stdout"
      failed_when: dietpi_update.rc != 0 and "'No updates required' not in dietpi_update.stdout"

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_flag

    - name: Reboot if required
      ansible.builtin.reboot:
        msg: "Rebooting after DietPi update"
        connect_timeout: 30
        reboot_timeout: 600
        pre_reboot_delay: 5
        post_reboot_delay: 10
      when: reboot_flag.stat.exists
